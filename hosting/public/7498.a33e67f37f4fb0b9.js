"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[7498],{7498:(I,L,l)=>{l.r(L),l.d(L,{VideoRecorderPageModule:()=>$});var E=l(6814),w=l(95),f=l(1929),b=l(2891),c=l(5861),r=l(9212),U=l(2389),M=l(7104),S=l(830);let P=(()=>{var a;class d{constructor(e,t){this.afs=e,this.storage=t}recordVideo(){var e=this;return(0,c.Z)(function*(){const t=yield navigator.mediaDevices.getUserMedia({video:!0}),o=new MediaRecorder(t),n=[];return o.start(),new Promise((v,i)=>{o.ondataavailable=u=>{n.push(u.data)},o.onstop=function(){var u=(0,c.Z)(function*(p){const g=new Blob(n,{type:"video/mp4"});console.log("Blob:",g);const h=e.storage.ref(`videos/${Date.now()}.mp4`);console.log("StorageRef:",h);try{const R=yield h.put(g);console.log("Upload successful:",R);const s=yield h.getDownloadURL().toPromise();console.log("Video URL:",s),v(s)}catch(R){console.error("Error uploading video:",R),i(new Error("Error al subir el video a Firebase"))}});return function(p){return u.apply(this,arguments)}}(),o.onerror=u=>{console.error("Error al grabar video:",u),i(new Error("Error al grabar video"))},setTimeout(()=>{o.stop()},5e3)})})()}getStorageRef(e){return this.storage.ref(e)}}return(a=d).\u0275fac=function(e){return new(e||a)(r.LFG(M.ST),r.LFG(S.Q1))},a.\u0275prov=r.Yz7({token:a,factory:a.\u0275fac,providedIn:"root"}),d})();const Z=[{path:"",component:(()=>{var a;class d{constructor(e,t,o,n,v,i,u){this.toastController=e,this.router=t,this.authService=o,this.firestore=n,this.estorage=v,this.changeDetector=i,this.emergencyService=u,this.videoRecorded=!1,this.recording=!1,this.countdownValue=0,this.recordingCountdownValue=5,this.successMessage=null}ngOnInit(){this.authService.getId().subscribe(e=>{(!e||!e.uid)&&(console.error("Usuario no autenticado. No se puede obtener el ID"),this.router.navigate(["loader"]))})}recordVideo(){var e=this;return(0,c.Z)(function*(){try{e.countdownValue=3,yield e.startRecordingAfterCountdown(),e.videoRecorded=!0,e.recording=!1,console.log("Video grabado con \xe9xito"),e.changeDetector.detectChanges()}catch(t){console.log("Error al grabar el video:",t),console.error("Error al grabar el video:",t)}})()}startRecording(){var e=this;return(0,c.Z)(function*(){try{const t=yield navigator.mediaDevices.getUserMedia({video:!0});e.videoStream=t,e.startRecordingAfterCountdown()}catch(t){console.log("Error al grabar el video:",t)}})()}startRecordingAfterCountdown(){var e=this;return(0,c.Z)(function*(){e.authService.getId().subscribe(function(){var t=(0,c.Z)(function*(o){e.recording=!0;const n=new MediaRecorder(e.videoStream),v=[];let i=5;n.start();const u=`videos/${o.uid}/${Date.now()}.mp4`;n.ondataavailable=g=>{v.push(g.data)},n.onstop=function(){var g=(0,c.Z)(function*(h){const R=new Blob(v,{type:"video/mp4"}),s=e.emergencyService.getStorageRef(u);try{yield s.put(R),s.getDownloadURL().subscribe(y=>{console.log("URL del video en Storage:",y),e.videoUrl=y,e.videoRecorded=!0,e.recording=!1,console.log("Video grabado con exito"),e.changeDetector.detectChanges(),e.videoStream.getTracks().forEach(A=>A.stop())},y=>{console.error("Error al obtener la URL del video:",y)}),(yield e.toastController.create({message:"Emergencia enviada exitosamente",duration:3e3,position:"bottom"})).present(),e.router.navigate(["/home"])}catch(V){console.error("Error al subir el video:",V)}yield e.saveEmergencyData()});return function(h){return g.apply(this,arguments)}}();const p=setInterval(()=>{i--,e.recordingCountdownValue=i,0===i&&(clearInterval(p),n.stop())},1e3);e.changeDetector.detectChanges()});return function(o){return t.apply(this,arguments)}}())})()}saveEmergencyData(){var e=this;return(0,c.Z)(function*(){e.authService.getId().subscribe(function(){var t=(0,c.Z)(function*(o){if(o&&o.uid&&o.email)try{e.latestVideo=yield e.getLatestMedia(o.uid,"videos"),e.latestAudio=yield e.getLatestMedia(o.uid,"audio"),e.latestImage=yield e.getLatestMedia(o.uid,"img"),e.latestMessage=yield e.getLatestMessage(o.email),e.latestLocation=yield e.getLatestLocation(o.uid),console.log("Datos antes de enviar la emergencia:",{pictureUrl:e.latestImage,videoUrl:e.latestVideo,audioUrl:e.latestAudio,locationLink:e.latestLocation,mensaje:e.latestMessage,userName:o.email}),yield e.firestore.collection("emergencias").add({uid:o.uid,latestVideo:e.latestVideo,latestAudio:e.latestAudio,latestImage:e.latestImage,latestMessage:e.latestMessage,latestLocation:e.latestLocation,userName:o.email,timestamp:(new Date).toLocaleString()}),console.log("Datos de emergencia guardados correctamente.")}catch(n){console.error("Error al guardar datos de emergencia:",n)}else console.error("Usuario no autenticado. No se puede obtener el ID")});return function(o){return t.apply(this,arguments)}}())})()}getLatestMedia(e,t){var o=this;return(0,c.Z)(function*(){return new Promise((n,v)=>{let i;switch(t){case"videos":i=".mp4";break;case"audio":i=".wav";break;case"img":i=".jpg";break;default:console.error(`Tipo de medio no soportado: ${t}`),n(null)}const u=o.estorage.ref(`${t}/${e}`);try{u.listAll().subscribe(g=>{let h=g.items.filter(s=>s.name.endsWith(i));0===h.length&&(console.log(`No se encontraron archivos ${t} para el usuario ${e}`),n(null)),h[h.length-1].getDownloadURL().then(s=>{console.log(`La URL del \xfaltimo archivo ${t} es ${s}`),n(s)}).catch(s=>{console.error(`Error al obtener la URL de descarga del \xfaltimo archivo ${t}:`,s),v(s)})},g=>{console.error(`Error al listar todos los archivos ${t}:`,g),v(g)})}catch(p){console.error(`Error al obtener los archivos ${t}:`,p),v(p)}})})()}getLatestMessage(e){var t=this;return(0,c.Z)(function*(){try{const o=yield t.firestore.collection("messages",n=>n.where("from","==",e).orderBy("createdAt","desc").limit(1)).get().toPromise();return o&&!o.empty?o.docs[0].data():(console.error("La consulta no retorn\xf3 ning\xfan resultado."),null)}catch(o){return console.log(o),console.error("Error al obtener el \xfaltimo mensaje:",o),null}})()}getLatestLocation(e){var t=this;return(0,c.Z)(function*(){try{const n=yield t.firestore.collection(`ubicaciones/${e}/user_locations`).ref.orderBy("timestamp","desc").limit(1).get();return n.empty?null:n.docs[0].data()}catch(o){return console.error("Error al obtener la \xfaltima ubicaci\xf3n:",o),null}})()}}return(a=d).\u0275fac=function(e){return new(e||a)(r.Y36(f.yF),r.Y36(b.F0),r.Y36(U.$),r.Y36(M.ST),r.Y36(S.Q1),r.Y36(r.sBO),r.Y36(P))},a.\u0275cmp=r.Xpm({type:a,selectors:[["app-video-recorder"]],decls:12,vars:2,consts:[[3,"translucent"],[3,"fullscreen"],["collapse","condense"],["size","large"],["vertical","bottom","horizontal","center","slot","fixed"],[3,"click"],["name","videocam-outline"]],template:function(e,t){1&e&&(r.TgZ(0,"ion-header",0)(1,"ion-toolbar")(2,"ion-title"),r._uU(3,"Grabar video"),r.qZA()()(),r.TgZ(4,"ion-content",1)(5,"ion-header",2)(6,"ion-toolbar")(7,"ion-title",3),r._uU(8,"Grabar video"),r.qZA()()(),r.TgZ(9,"ion-fab",4)(10,"ion-fab-button",5),r.NdJ("click",function(){return t.startRecording()}),r._UZ(11,"ion-icon",6),r.qZA()()()),2&e&&(r.Q6J("translucent",!0),r.xp6(4),r.Q6J("fullscreen",!0))},dependencies:[f.W2,f.IJ,f.W4,f.Gu,f.gu,f.wd,f.sr]}),d})()}];let D=(()=>{var a;class d{}return(a=d).\u0275fac=function(e){return new(e||a)},a.\u0275mod=r.oAB({type:a}),a.\u0275inj=r.cJS({imports:[b.Bz.forChild(Z),b.Bz]}),d})(),$=(()=>{var a;class d{}return(a=d).\u0275fac=function(e){return new(e||a)},a.\u0275mod=r.oAB({type:a}),a.\u0275inj=r.cJS({imports:[E.ez,w.u5,f.Pc,D]}),d})()}}]);